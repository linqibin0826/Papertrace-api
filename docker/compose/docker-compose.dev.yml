version: "3.9"
services:
  mysql:
    image: mysql:8.0.36
    container_name: patra-mysql
    restart: unless-stopped
    ports: ["13306:3306"]
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      TZ: Asia/Shanghai
    command: >
      --default-authentication-plugin=caching_sha2_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_0900_ai_ci
      --lower_case_table_names=1
      --explicit_defaults_for_timestamp=ON
      --max_connections=300
    volumes:
      - ../mysql/data:/var/lib/mysql
      - ../mysql/conf.d:/etc/mysql/conf.d
      - ../mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -uroot -p123456 -h 127.0.0.1 --silent"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7.0.15
    container_name: patra-redis
    restart: unless-stopped
    ports: ["16379:6379"]
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ../redis/data:/data
      - ../redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  nacos:
    image: nacos/nacos-server:v2.5.1-slim        # Apple 芯片推荐 slim；若拉不动再加: platform: linux/amd64
    # platform: linux/amd64
    container_name: patra-nacos
    restart: unless-stopped
    environment:
      - MODE=standalone
      - TZ=Asia/Shanghai
      # ✅ 不要设置 SPRING_DATASOURCE_PLATFORM / MYSQL_*，这样才会走 Derby
      # 🔐 鉴权三件套（2.2.1+ 必填）
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN=wur4obqxgTEPKRgkbloX3m4Gx+uUuIuIsp6YjKrGgv0=
      - NACOS_AUTH_IDENTITY_KEY=papertrace
      - NACOS_AUTH_IDENTITY_VALUE=papertrace
      # JVM（本地）
      - JVM_XMS=256m
      - JVM_XMX=256m
      - JVM_XMN=128m
    ports:
      - "8848:8848"   # Console & OpenAPI
      - "9848:9848"   # gRPC
      - "9849:9849"   # gRPC
    volumes:
      - ../nacos/logs:/home/nacos/logs
      - ../nacos/data:/home/nacos/data   # ✅ 建议把 data 也挂出来，保证可写
    healthcheck:
      test: [ "CMD", "curl", "-fs", "http://localhost:8848/nacos/" ]
      interval: 10s
      timeout: 5s
      retries: 30


networks:
  default:
    name: patra-net
