# `patra-registry-domain`

> 领域层（domain）承载业务语义的“内核”。维护实体、值对象、聚合与领域事件，并通过 **端口（Ports）** 定义对外依赖的最小必要契约。任何技术细节（ORM、事务、缓存、Web）一概不进入此层。

---

## 1. 职责边界

* 定义：实体（Entity）、值对象（VO）、聚合（Aggregate）、领域事件（Domain Event）、领域枚举（Enums）、仓储端口（Repository Ports）。
* 只表达领域不变量与业务规则；不包含持久化、网络、缓存、消息中间件、事务框架等实现细节。
* 对外以 **port**（接口）暴露最小必要依赖，供 infra 实现；infra 通过 DO/映射细节落地，且不得反向侵入领域。

---

## 2. 依赖与禁区

* **仅允许依赖**：`patra-common`（已引入 hutool-core）、JDK。
* 禁止依赖：Spring 全家桶、MyBatis/MP、Web/网关 SDK、app、adapter、api 等任意技术框架与上层模块。

---

## 3. 包结构

**包根**：`com.patra.registry.domain`

```
model/
  aggregate/        // 聚合根与子实体/值对象
  vo/               // 不可变值对象
  event/            // 领域事件：描述已发生的事实
  enums/            // 领域枚举（跨层复用）
port/
  *Repository.java  // 仓储端口：以聚合为单位 load/save
```

无注解、强类型值对象、以聚合为单位的端口，并强调领域枚举由 domain 统一定义、跨层复用，数据层 DO 直接使用该枚举。

---

## 4. 建模原则

* 聚合边界清晰：外部只能通过聚合根改变内部状态；不变量在构造与状态变更时强制校验。
* 值对象不可变：通过构造器/工厂方法保证有效态；等价性基于值。
* 显式领域概念：标识对象、业务主键、配置对象等概念独立建模。
* 行为优先于属性：通过方法表达业务意图（如启用/禁用），幂等性在行为中自证。
* 领域事件：描述已发生的业务事实，不包含技术元数据（如事务/重试信息）。

---

## 5. 端口与仓储契约

* 只以聚合为单位。
* 不暴露行级 CRUD、不返回数据层 DO，不泄漏持久化细节。
* 并发与版本：由 infra 在 DO 层实现乐观锁等机制；domain 仅定义语义化异常/规则。

---

## 6. 行为与不变量校验

* 规则集中于聚合：如配置对象的拉取间隔、限流阈值、唯一性约束等在聚合内校验。
* 幂等行为：命令重复调用应无副作用。
* 错误语义：抛出领域化异常（如 `InvalidCode`、`DuplicateCode`），由上层翻译为应用/接口错误。

---

## 7. 领域枚举（Enums）

* 统一在 `domain.model.enums` 定义，跨层复用；其他层不再重复定义（api 可定义对外协议所需的独立枚举）。

* 数据层 DO 直接使用该枚举，避免“魔法字符串/数字”。

* 如果枚举值需要存储到数据库字段，必须实现 `patra-common` 包中的接口：

  ```java
  package com.patra.common.enums;

  public interface CodeEnum<C> {
      C getCode();
  }
  ```

* 二值开关场景（启用/禁用）：直接使用 `boolean`，不需要枚举。

---

## 8. 与 infra 的协作约定

* infra 负责 DO ↔ 聚合/值对象 的映射与持久化，实现 `domain.port.*`；
* 缓存、迁移、事务、审计、分页、乐观锁冲突转译等均在 infra 处理；domain 不感知技术实现。

---

## 9. 代码风格与工具

* 不要在 domain 随意增加工具方法；如需通用工具，直接使用 `hutool-core`（`patra-common` 已引入）：

    * 断言校验：`Assert`
    * 字符串/集合工具：`StrUtil`、`CollUtil`
    * 时间：`DateUtil` / `LocalDateTimeUtil`
    * 随机与 ID：`IdUtil`
* 零注解/零框架：领域对象不出现 `@Component`/`@Entity`/`@Table` 等技术注解。

---

## 10. 测试策略

* 纯单测优先：对聚合行为与不变量进行 **状态转移测试**（Given-When-Then）。
* 使用测试构造器/母体对象（Object Mother）快速构造有效聚合。
* 针对边界条件（唯一性、幂等、阈值）编写参数化用例。
* 不依赖数据库：infra 才需要集成测试；domain 使用内存构造与伪端口替身。

---

## 11. 版本演进与兼容性

* 领域对象的向后兼容由聚合内部处理（新增字段提供默认/工厂方法）。
* 事件模型变更采用 **版本化策略**（事件名或字段加版本），保留旧事件一段时间以过渡。

---

**额外提醒**：不要随意加工具方法。能用 Hutool 就别自己造螺丝刀；`patra-common` 已经把 hutool-core 带进来，拿来即用，轻装上阵。
