<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.patra.registry.infra.persistence.mapper.provenance.RegProvCredentialMapper">
    <select id="selectActiveMerged" resultType="com.patra.registry.infra.persistence.entity.provenance.RegProvCredentialDO">
        SELECT *
        FROM reg_prov_credential
        WHERE deleted = 0
          AND lifecycle_status_code = 'ACTIVE'
          AND provenance_id = #{provenanceId}
          AND effective_from &lt;= #{now}
          AND (effective_to IS NULL OR effective_to &gt; #{now})
          AND scope_code IN ('TASK','SOURCE')
          AND task_type_key IN (#{taskTypeKey}, 'ALL')
          AND (
                (#{endpointId} IS NOT NULL AND endpoint_id = #{endpointId})
             OR (#{endpointId} IS NULL AND endpoint_id IS NULL)
          )
        ORDER BY
          CASE scope_code WHEN 'TASK' THEN 1 ELSE 2 END,
          CASE WHEN task_type_key = #{taskTypeKey} THEN 1 ELSE 2 END,
          -- endpoint 精确优先
          CASE WHEN endpoint_id IS NOT NULL THEN 1 ELSE 2 END,
          is_default_preferred DESC,
          effective_from DESC,
          id DESC
    </select>
</mapper>
