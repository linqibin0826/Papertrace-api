# `patra-registry-app`

> 应用层（app）是**用例编排层**：负责权限检查、事务边界、聚合协作与集成事件发布。调用 `domain` 的领域模型，不直接涉及持久化或对外协议细节。

---

## 1. 职责边界

* **用例编排**：权限校验 → 载入聚合 → 调用聚合行为 → 仓储保存 → 发布应用/集成事件。
* **异常翻译**：将领域异常转换为应用异常，对上保持受控、稳定的错误语义。
* **事件封装**：定义应用层事件模型，供适配层转发到外部系统（MQ/HTTP 等）。
* **与领域解耦**：不承载业务规则本身（业务规则归属 `domain`），只负责驱动与编排。

---

## 2. 依赖与禁区

* ✅ 允许依赖：`domain`、`patra-common`、`patra-spring-boot-starter-core`、以及**纯工具型库**（无网络/IO副作用，如 MapStruct、校验、集合/字符串/时间工具）。
* ⛔ 禁止依赖：`infra`、Web 框架、`api` DTO/协议类、**外部系统 SDK（HTTP 客户端、MQ 客户端、云厂商 SDK 等）**。
* 📌 **外部 SDK 接入准则**：
    * **应由 adapter/infra 封装**并以端口（接口）形式供 app 调用；app 依赖的是**端口接口**而非 SDK 本身。
    * 若确有“纯工具型、零 IO、与业务无关”的库（例如 Bean 映射），可在 app 使用，但不得嵌入外部调用流程。

---

## 3. 目录结构

```
service/                // 用例编排入口（权限/事务/聚合协作）
usecase/                // 入参/用例模型（与 adapter 共享）
  command/
  query/
mapping/                // app ↔ domain 映射（Assembler/MapStruct）
security/               // 权限/策略检查接口
event/                  // 应用层事件模型
  publisher/            // 事件发布抽象与实现（对外交由 adapter 承担）
tx/                     // 幂等/分布式锁/事务等辅助
config/                 // 仅 app 层需要的 Bean
```

---

## 4. 用例编排规范

* **单一入口**：每个用例由一个 `*AppService` 暴露。
* **执行链**：

    1. 调用 `security` 做权限/策略检查；
    2. 通过 `domain.port.*` 加载聚合；
    3. 以**行为**驱动聚合（执行业务规则在 domain 内部）；
    4. 保存聚合（依赖 domain 的仓储端口）；
    5. 构造并发布**应用事件**（交由适配层实际对外发送）。
* **返回**：面向上层返回 DTO/View（不要暴露领域对象）。

---

## 5. 权限与安全

* 在 `security` 包定义策略检查接口与必要实现；
* **不要**把安全逻辑散落在 `service` 与 `usecase`；
* 如需对接外部鉴权系统，其 SDK/HTTP 客户端放在 **adapter** 封装，app 仅依赖其**接口**。

---

## 6. 事件与发布

* 在 `event` 中定义**应用事件模型**（强调事实与上下文，不携带领域对象本体）。
* `publisher` 只暴露**发布接口/适配点**；实际对 MQ/HTTP 的发送由 **adapter** 承担（SDK 在 adapter）。
* 支持**事件版本化**，兼容旧订阅方。

---

## 7. 事务与幂等

* **app 是主要事务边界**（例如标注事务、统一提交/回滚）。
* `tx` 包提供幂等守卫、分布式锁等设施；
* `infra` 可在必要时提供最小粒度事务，但不替代 app 的边界控制。

---

## 8. 映射与转换

* `mapping` 统一处理 app ↔ domain 的对象转换（Assembler 或 MapStruct）。
* **不要**在 `service` 中散写字段拷贝；
* 输入（command/query）与输出（DTO/View）与聚合模型解耦，保持**稳定 API，演进由映射适配**。

---

## 9. 测试策略

* **用例级单测**：覆盖权限→加载→聚合→保存→事件完整链路；
* 使用**替身仓储**与**替身安全检查**隔离外部影响；
* 验证**异常翻译**与**事件发布**是否符合预期。

---

## 10. 代码风格与工具

* **业务规则不进 app**，一切规则进入 domain；
* 可使用 `hutool-core`（已由 `patra-common` 引入）做断言、字符串、集合、时间等通用处理；
* `AppService` 方法保持**语义单一**、**易读**、**可测试**。

---

## 11. 版本演进

* 新增用例请新建 `command/query`，避免破坏已有协议；
* 应用事件采用**版本号策略**渐进演进，确保下游安全升级。

---

> `app` = **业务编排层**。像乐团指挥：手里的谱子是用例，乐手是领域模型，舞台控灯和录音是 adapter/infra。各司其职，声音才干净。
