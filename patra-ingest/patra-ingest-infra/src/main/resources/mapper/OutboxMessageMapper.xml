<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.patra.ingest.infra.persistence.mapper.OutboxMessageMapper">

    <select id="lockPending" resultType="com.patra.ingest.infra.persistence.entity.OutboxMessageDO">
        SELECT
            *
        FROM patra_ingest.ing_outbox_message
        WHERE channel = #{channel}
          AND status_code = #{status}
          AND (not_before IS NULL OR not_before  &lt;= #{available})
          AND (next_retry_at IS NULL OR next_retry_at &lt;= #{available})
        ORDER BY id
        LIMIT #{limit}
        FOR UPDATE SKIP LOCKED
    </select>

    <update id="markPublishing">
        UPDATE patra_ingest.ing_outbox_message
        SET status_code = 'PUBLISHING',
            pub_lease_owner = #{leaseOwner},
            pub_leased_until = #{leaseExpireAt},
            updated_at = NOW(6),
            version = version + 1
        WHERE id = #{id}
          AND status_code = #{expectedStatus}
          AND (
              (#{expectedVersion} IS NULL AND version IS NULL)
              OR version = #{expectedVersion}
          )
    </update>

    <update id="markPublished">
        UPDATE patra_ingest.ing_outbox_message
        SET status_code = 'PUBLISHED',
            msg_id = #{msgId},
            pub_lease_owner = NULL,
            pub_leased_until = NULL,
            error_code = NULL,
            error_msg = NULL,
            next_retry_at = NULL,
            updated_at = NOW(6),
            version = version + 1
        WHERE id = #{id}
          AND status_code = 'PUBLISHING'
          AND (
              (#{expectedVersion} IS NULL AND version IS NULL)
              OR version = #{expectedVersion}
          )
    </update>

    <update id="markRetry">
        UPDATE patra_ingest.ing_outbox_message
        SET status_code = 'PENDING',
            retry_count = #{retryCount},
            next_retry_at = #{nextRetryAt},
            error_code = #{errorCode},
            error_msg = #{errorMsg},
            msg_id = NULL,
            pub_lease_owner = NULL,
            pub_leased_until = NULL,
            updated_at = NOW(6),
            version = version + 1
        WHERE id = #{id}
          AND status_code = 'PUBLISHING'
          AND (
              (#{expectedVersion} IS NULL AND version IS NULL)
              OR version = #{expectedVersion}
          )
    </update>

    <update id="markDead">
        UPDATE patra_ingest.ing_outbox_message
        SET status_code = 'DEAD',
            retry_count = #{retryCount},
            error_code = #{errorCode},
            error_msg = #{errorMsg},
            next_retry_at = NULL,
            msg_id = NULL,
            pub_lease_owner = NULL,
            pub_leased_until = NULL,
            updated_at = NOW(6),
            version = version + 1
        WHERE id = #{id}
          AND status_code = 'PUBLISHING'
          AND (
              (#{expectedVersion} IS NULL AND version IS NULL)
              OR version = #{expectedVersion}
          )
    </update>

</mapper>
